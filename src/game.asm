
	INCLUDE	SHIKE2.INC
	INCLUDE BIOS.INC
	INCLUDE KBD.INC
	INCLUDE	EDITOR.INC

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

	CSEG
	PUBLIC	GAME
	EXTRN	CHARACTERS,NEWFRAME,MAP,DELSPR,VDPSYNC
	EXTRN	INITCHAR,INITMOB

GAME:	CALL	DISSCR			;DISABLE SCREEN
	CALL	DELSPR			;DELETE SPRITES DEFINITION
	CALL	CLEARPAGES		;CLEAR VRAM PAGES
	LD	DE,LVLMAP
	CALL	MAP
	CALL	COPYPAGES		;DO PAGES 0,1,2 HAVE SAME CONTENT
	LD	A,TILPAGE
	LD	(DPPAGE),A
	INC	A
	LD	(ACPAGE),A		;SET THE CORRECT PAGES
	CALL	VDPSYNC			;WAIT TO THE VDP
	CALL	ENASCR			;ENABLE SCREEN

	CALL	INITMOB
	CALL	INITCHAR
G.LOOP: CALL	NEWFRAME
	CALL	CHARACTERS
	JR	G.LOOP

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

	CSEG
	EXTRN	CLRVPAGE

CLEARPAGES:
	LD	E,0
	CALL	CLRVPAGE		;CLEAN THE THREE PAGES
	LD	E,1
	CALL	CLRVPAGE
	LD	E,2
	JP	CLRVPAGE

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

	CSEG
	EXTRN	HMMM,VDPPAGE

COPYPAGES:
	LD	A,TILPAGE+1		;UPDATE THE THREE PAGES
	CALL	C.AUX
	LD	A,BAKPAGE
C.AUX:	LD	(ACPAGE),A
	LD	HL,0
	LD	DE,0
	LD	BC,0FFD8H
	LD	A,TILPAGE
	LD	(VDPPAGE),A
	JP	HMMM

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

	PUBLIC	ENGINE
ENGINE:	RET

