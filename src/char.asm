	INCLUDE	KBD.INC
	INCLUDE GEOMETRY.INC

NR_CHARS	EQU	8		;NUMBER OF CHARACTERS IN THE FULL GAME


;CHARACTER COORDENATES HAVE THE FORM (MAP,SCR,X,Y)

CHAR.MAP	EQU	0
CHAR.SCR	EQU	1
CHAR.X		EQU	2
CHAR.Y		EQU	3
CHAR.DIR	EQU	4
CHAR.DIRCNT	EQU	5
CHAR.PAT	EQU	6
CHAR.SIZ	EQU	7

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

	CSEG
	PUBLIC	INITCHAR
	EXTRN	MEMSET

INITCHAR:
	LD	B,NR_CHARS
	LD	IX,BUFFER
	LD	DE,CHAR.SIZ
	XOR	A

I.LOOP:	LD	(IX+CHAR.X),A
	LD	(IX+CHAR.Y),A
	LD	(IX+CHAR.DIR),D.NODIR
	ADD	IX,DE
	DJNZ	I.LOOP
	RET

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

	CSEG
	PUBLIC	CHARACTERS

CHARACTERS:
	LD	IX,BUFFER
	;CONTINUE IN KBCONTROL

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;INPUT:	IX = POINTER TO THE CHARACTER

	CSEG
	EXTRN	GETCH,KEY2DIR,MOVEUC,WRLD2SCR,PUTMOB,EXIT

KBCONTROL:
	LD	A,(IX+CHAR.DIR)
	CP	D.NODIR
	JR	Z,K.GETCH
	DEC	(IX+CHAR.DIRCNT)
	JR	NZ,K.MOVE

K.GETCH:LD	A,D.NODIR
	LD	(IX+CHAR.DIR),A
	CALL	GETCH
	RET	Z
	CP	KB_ESC
	CALL	Z,EXIT
	CALL	KEY2DIR
	LD	(IX+CHAR.DIR),A
	RET	C
	LD	A,2
	LD	(IX+CHAR.DIRCNT),A

K.MOVE:	LD	A,(IX+CHAR.DIR)
	LD	D,(IX+CHAR.X)
	LD	E,(IX+CHAR.Y)
	CALL	MOVEUC
	LD	A,255
	CP	D
	RET	Z
	CP	E
	RET	Z
	LD	A,32			;TODO: CHANGE IT AND DON'T MIX
	CP	D			;SCREEN ISSUES WITH WORLD ISSUES
	RET	Z
	CP	E
	RET	Z
	LD	(IX+CHAR.X),D
	LD	(IX+CHAR.Y),E

	LD	BC,7814H
	CALL	WRLD2SCR
	LD	BC,0
	JP	PUTMOB

	DSEG
BUFFER:	DS	CHAR.SIZ * NR_CHARS
