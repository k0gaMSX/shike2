
	INCLUDE	BIOS.INC

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

	CSEG
	PUBLIC	INITMOUSE

MOUSE1	EQU	12			;DEVICE ID FOR MOUSE 1
MOUSE2	EQU	16			;DEVICE ID FOR MOUSE 2

INITMOUSE:
	LD	A,MOUSE1
	LD	(MPORT),A
	CALL	ISCONN			;IS IT CONNECTED?
	RET	NZ

	LD	A,MOUSE2
	LD	(MPORT),A
	CALL	ISCONN			;IS IT CONNECTED?
	RET	NZ

	XOR	A
	LD	(MPORT),A
	RET

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;INPUT:	A = MOUSE PORT
;OUTPUT:ZF = 1 WHEN IT IS NOT CONNECTED

	CSEG

ISCONN:	LD	B,3
	LD	E,A

I.LOOP:	PUSH	DE			;READ THE MOUSE INCREMENT
	PUSH	BC			;IF YOU GET XINC=1 AT LEAST

	LD	A,E			;3 TIMES, WE CAN THINK IT IS
	PUSH	AF			;DISCONNECTED
	CALL	GTPAD
	POP	AF
	INC	A
	CALL	GTPAD
	POP	BC
	POP	DE

	CP	1
	RET	NZ
	EI
	HALT
	DJNZ	I.LOOP
	RET

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

	CSEG
	PUBLIC	MOUSEHOOK,MOUSEX,MOUSEY
	EXTRN	SEXPAND

MOUSEHOOK:
	LD	A,(MPORT)
	OR	A
	RET	Z
	CALL	GTPAD			;CHECK MOUSE POSITION
	LD	HL,(MOUSEX)
	LD	H,0
	LD	DE,(SAVEX)
	CALL	SEXPAND			;CONVERT X INCREMENT TO 16 BITS
	ADD	HL,DE
	LD	DE,255
	CALL	ADJUST			;CHECK CORRECT POSITION
	LD	(MOUSEX),A

	LD	HL,(MOUSEY)
	LD	H,0
	LD	DE,(SAVEY)
	CALL	SEXPAND			;CONVERT Y INCREMENT TO 16 BITS
	ADD	HL,DE
	LD	DE,211
	CALL	ADJUST			;CHECK CORRECT POSITION
	LD	(MOUSEY),A
	RET

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;INPUT:	HL = COORDENATE
;	DE = LIMIT
;OUTPUT:A = ADJUSTED COORDENATED

	CSEG

ADJUST:	LD	A,H
	BIT	7,H
	JR	NZ,A.NEG

	CALL	DCOMPR
	JP	NC,A.BIG
	LD	A,L
	RET

A.NEG:	XOR	A
	RET

A.BIG:	LD	A,E
	RET


	DSEG
MPORT:	DB	0
MOUSEX:	DB	0
MOUSEY:	DB	0

